---
title: "Estratégia em Finanças - Artigo"
author: "A. Schmidt"
date: "May 5, 2019"
header-includes:
   - \usepackage{bigints}
   - \usepackage[brazil]{babel}
   - \usepackage{graphicx}
   - \usepackage{amsmath}
output: html_document
---

# Introduction

This code downloads and analyzes the data for my term paper for the "Estratégia em Finanças" course, taken in 2019-2. 

My to-do list is:

* Write an script to download the data from the [30 mining companies listed on NYSE](https://www.investing.com/stock-screener/?sp=country::5|sector::a|industry::16|equityType::a|exchange::1%3Ceq_market_cap;1);
    * *Stretch goal*: get some control data, for example prices of mining ore, SP500 index
* Clear data to get the daily returns;
    * *Stretch goal*: Get the list of the calendar business days to make easier to cross with the disaster;
    * *Stretch goal*: Compare the prices of the Vale do Rio Doce stocks in B3 (former BM&F) and NYSE;
* Find the cut point in the series to split the data for two separate sets: one for the Mariana disaster (05/11/2015) and another for Brumadinho disaster (25/01/2019);
* Get the package and documentation for the synthetic control;
    * Run some cluster analysis;
    * See if the differences (if exist) are equal between the two disasters.

What I have been into (updated on 13/05):

* I downloaded the stock info and calculated returns;
* I downloaded volume to use as regressor;
* I've read a bunch of stuff about Synth package.

Where I am currently:

* I'm trying to get the data frame right in order to build the synthetic Vale. What I need is:
  * A data frame where the first column is the name of the company and has the return and volume, as well as the Data and a column with numerical indexes for the Time and for the Company;
  * A data frame with the indexes only for the controls (?)

Some links I crossed upon and might come in hand in the future:

* Making tables in Markdown:
    * https://www.displayr.com/formattable/?utm_medium=Feed&utm_source=Syndication
    * https://www.jakeruss.com/cheatsheets/stargazer/#the-default-summary-statistics-table
    * https://www.princeton.edu/~otorres/NiceOutputR.pdf
    * https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html
    * https://people.ok.ubc.ca/jpither/modules/Tables_markdown.html
    * https://rstudio-pubs-static.s3.amazonaws.com/132624_226026c074754b4484948fe3f70eceeb.html

* `Quantmod` package (to get data):

    * https://rstudio-pubs-static.s3.amazonaws.com/364194_96fa6ffa96d84b4ea95e831592214b97.html
    * https://www.quantmod.com/examples/data/

* Synthetic control in R
    * https://towardsdatascience.com/causal-inference-using-difference-in-differences-causal-impact-and-synthetic-control-f8639c408268
    * http://rpubs.com/danilofreire/synth
    * https://cran.r-project.org/web/packages/microsynth/vignettes/introduction.html
    * https://yiqingxu.org/software/gsynth/gsynth_examples.html
    * https://core.ac.uk/download/pdf/86439379.pdf
    * https://aheblog.com/2017/11/02/method-of-the-month-synthetic-control/
    * https://www.urban.org/sites/default/files/publication/89246/the_synthetic_control_method_as_a_tool_1.pdf

## Downloading packages

If mirror 10 ("UFRJ") is offline, try changing `ind = 10` to `ind = 1`. Do the same thing if you get an error installing the `BETS` package.

```{r, warning = FALSE, message = FALSE}
chooseCRANmirror(graphics = FALSE, ind = 10)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(ggplot2, forecast, BETS, seasonal, seasonalview, lubridate, zoo, stargazer, gridExtra, reshape2, ggfortify, RColorBrewer, scales, quantmod, PerformanceAnalytics, strucchange, knitr, grid, ggpubr, gdata, vars, urca, compiler, DescTools, kableExtra, readxl, tseries, Synth) 
```

# Downloading and preparing data

First, I need to get the symbols list, they are in a github repo.

```{r, message = FALSE, warning = FALSE}
#sheet   <- read.csv("D:\\Onedrive - Aisha\\OneDrive\\Documentos\\Graduação Economia UDESC\\2019-1\\Estratégia em Finanças - Daniel\\Artigo da disciplina\\Mining companies listed on NYSE.csv")
sheet <- read.csv("https://raw.githubusercontent.com/aishameriane/Vale-Stock-and-Disasters/master/Mining%20companies%20listed%20on%20NYSE.csv?token=AAVGJTVQ6NHJQVC625KDS2S44IIYS")
colnames(sheet)[1] <- "Name"
sheet <- sheet[-c(18,19,5),] # for some reson the thing does not understand the -P notation for the preferential stocks, so for now I removed them
symbols <- as.character(sheet[,2])
```

I removed the preferential stocks from Arconic and Mechel (lines 5 and 19), as well as Nexa Resources because the series started on Oct 2017.

Other stock that may be a problem is VEDL because the series starts on 01/09/2013, but I'll wait before removing it. NexGen (NXE) starts on Aug, 2013. All others have at least 10 years of data, so I'm not removing them at all. 

```{r, message = FALSE, warning = FALSE}
getSymbols(symbols, src = 'yahoo', from = "2014-01-01", to = "2019-01-01", 
             auto.assign = TRUE, warnings = FALSE) 
prices <- merge(BHP, BBL, RIO, VALE, SCCO, FCX, ACH, ARNC, VEDL, AA, CCJ, TRQ, CLF, CMC, HBM, HSC, MTL, NXE, LAC, UEC, PLM, TGB, URG, PLG, UAMY, GMO, XPL)
volume <- prices[,grepl( "Volume" , names(prices) )]
prices <- prices[,grepl( "Close" , names(prices) )]
colnames(volume) <- as.character(sheet[,1])
colnames(prices) <- as.character(sheet[,1])

returns <- diff(log(prices))
n <- length(returns)
returns <- returns[-1,]
volume  <- volume[-1,]
```

# Exploring data

```{r, message = FALSE, warning = FALSE}
datas        <- time(returns)
#df1          <- data.frame(datas, returns, seq(1, nrow(volume), by = 1))
df1          <- data.frame(datas, returns)
#names(df1)[29] <- "tempo_id"
returns_melt <- melt(data = df1, id.vars = "datas")

datas        <- time(volume)
#df2 <- data.frame(datas, volume, seq(1, nrow(volume), by = 1))
df2 <- data.frame(datas, volume)
#names(df2)[29] <- "tempo_id"
volume_melt <- melt(data = df2, id.vars = "datas")

df3 <- data.frame(datas, seq(1, length(datas), by = 1))
names(df3) <- c("Data", "Time_id")

cores <- brewer.pal(30, "Dark2")

p4 <- ggplot(returns_melt, aes(datas, value, colour = variable)) +
        geom_line(show.legend=T)+
        #scale_y_continuous(name="Coefficient", limits = c(-22, 15)) +
        #scale_colour_manual(values = c(cores[4], cores[3], cores[6], cores[5], cores[1]))+
        #scale_x_date(date_breaks = "24 months", name = "Year", labels = date_format("%Y"))+ 
        theme_bw()
p4 <- p4 + theme(axis.text.x = element_text(angle=25, hjust = 1, size = 6), axis.title.x = element_blank(), axis.title.y = element_text(size = 6), legend.text = element_text(size=6), legend.title = element_text(size=6), axis.text.y = element_text(size=6)) 
p4

names(returns_melt) <- c("Data", "Company", "Return")
names(volume_melt) <- c("Data", "Company", "Volume")

data_frame <- merge(returns_melt, volume_melt, by = c("Data", "Company"))
data_frame_alt <- merge(data_frame, df3, by = c("Data"))

# I HAVE TO COME BACK AND ADD THE INDEX
data_frame_alt <- data.frame(data_frame_alt[,2], data_frame_alt[,1], data_frame_alt[,3], data_frame_alt[,4], data_frame_alt[,5])
names(data_frame_alt) <- c("Company", "Data", "Return", "Volume", "Time_id")
```


# Trying the first synthetic

```{r, warning = FALSE, message = FALSE, eval = FALSE}
controles <-  unique(data_frame[data_frame$Company!="Vale.ADR",1])
controles_2 <- data.frame(unique(data_frame_alt[,1]), 1:(length(controles)+1))
controles <- controles_2[-26,2]
names(controles_2) <- c("Company", "Index")

data_frame <- merge(data_frame_alt, controles_2, by = "Company")

data_frame[1,1]

data_frame$Company <- as.character(data_frame$Company)
```

I'm still having trouble organizing the data

```{r, eval = FALSE}
vale_controle <- dataprep(
  foo=data_frame,
  predictors = 'Volume', 
  predictors.op = 'mean',
  time.predictors.prior = 1:491,
  dependent = 'Return',
  unit.variable = 'Index.x',
  unit.names.variable = 'Company',
  time.variable = 'Data',
  treatment.identifier = 26,
  controls.identifier = controles,
  time.optimize.ssr = 1:491,
  time.plot = 1:1257)
```

